<!-- ========================================
     FACTURES VIEW
     Invoice management with filters and actions
     ======================================== -->

<div class="invoices-container">
    <!-- Header with Actions -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">Gestion des factures</div>
            <button class="btn btn-primary" onclick="openNewInvoiceModal()">
                ‚ûï Nouvelle facture
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <div class="form-group">
                <label class="form-label">Statut</label>
                <select id="filterStatus" class="form-select" onchange="filterInvoices()">
                    <option value="">Tous</option>
                    <option value="draft">Brouillon</option>
                    <option value="sent">Envoy√©e</option>
                    <option value="paid">Pay√©e</option>
                    <option value="overdue">En retard</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Recherche</label>
                <input type="text" id="filterSearch" class="form-input" 
                       placeholder="N¬∞ facture ou client..." 
                       onkeyup="filterInvoices()">
            </div>
            
            <div class="form-group">
                <label class="form-label">Date d√©but</label>
                <input type="date" id="filterDateStart" class="form-input" 
                       onchange="filterInvoices()">
            </div>
            
            <div class="form-group">
                <label class="form-label">Date fin</label>
                <input type="date" id="filterDateEnd" class="form-input" 
                       onchange="filterInvoices()">
            </div>
        </div>
        
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-outline" onclick="resetFilters()">
                üîÑ R√©initialiser
            </button>
            <button class="btn btn-outline" onclick="exportInvoices()">
                üìä Exporter
            </button>
        </div>
    </div>

    <!-- Invoices Table -->
    <div class="card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>N¬∞ Facture</th>
                    <th>Client</th>
                    <th>Date</th>
                    <th>√âch√©ance</th>
                    <th>Total HT</th>
                    <th>Total TTC</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="invoicesTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 2rem;">
                        Chargement des factures...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
console.log('üìÑ Factures view loaded');

let allInvoices = [];
let filteredInvoices = [];

async function loadInvoices() {
    console.log('Loading invoices...');
    
    try {
        allInvoices = await window.InvoiceAPI.list();
        filteredInvoices = allInvoices;
        displayInvoices(filteredInvoices);
        
        console.log('‚úÖ Invoices loaded:', allInvoices.length);
        
    } catch (error) {
        console.error('‚ùå Invoice loading failed:', error);
        document.getElementById('invoicesTableBody').innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--danger);">
                    Erreur de chargement<br>
                    <button class="btn btn-outline" onclick="loadInvoices()" style="margin-top: 1rem;">
                        R√©essayer
                    </button>
                </td>
            </tr>
        `;
    }
}

function displayInvoices(invoices) {
    const tbody = document.getElementById('invoicesTableBody');
    if (!tbody) return;

    if (!invoices || invoices.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 2rem; color: var(--text-gray);">
                    Aucune facture trouv√©e
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = invoices.map(inv => `
        <tr>
            <td><strong>${escapeHtml(inv.number)}</strong></td>
            <td>${escapeHtml(inv.client_name || '-')}</td>
            <td>${formatDate(inv.invoice_date)}</td>
            <td>${formatDate(inv.due_date)}</td>
            <td style="text-align: right;">${formatCurrency(inv.total_ht || 0)}</td>
            <td style="text-align: right;"><strong>${formatCurrency(inv.total_ttc || 0)}</strong></td>
            <td>
                ${inv.status === 'paid' ? createBadge('Pay√©e', 'success') :
                  inv.status === 'sent' ? createBadge('Envoy√©e', 'warning') :
                  inv.status === 'overdue' ? createBadge('En retard', 'danger') :
                  createBadge('Brouillon', 'info')}
            </td>
            <td>
                <div style="display: flex; gap: 0.5rem;">
                    ${createButton('üëÅÔ∏è', `viewInvoice('${inv.id}')`, 'btn btn-outline')}
                    ${createButton('üìÑ', `downloadInvoicePDF('${inv.id}')`, 'btn btn-primary')}
                    ${inv.status !== 'paid' ? createButton('‚úì', `markInvoiceAsPaid('${inv.id}')`, 'btn btn-success') : ''}
                </div>
            </td>
        </tr>
    `).join('');
}

function filterInvoices() {
    const status = document.getElementById('filterStatus').value;
    const search = document.getElementById('filterSearch').value.toLowerCase();
    const dateStart = document.getElementById('filterDateStart').value;
    const dateEnd = document.getElementById('filterDateEnd').value;

    filteredInvoices = allInvoices.filter(inv => {
        if (status && inv.status !== status) return false;
        
        if (search && !(
            (inv.number || '').toLowerCase().includes(search) ||
            (inv.client_name || '').toLowerCase().includes(search)
        )) return false;
        
        if (dateStart && inv.invoice_date < dateStart) return false;
        if (dateEnd && inv.invoice_date > dateEnd) return false;
        
        return true;
    });

    displayInvoices(filteredInvoices);
}

function resetFilters() {
    document.getElementById('filterStatus').value = '';
    document.getElementById('filterSearch').value = '';
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    filteredInvoices = allInvoices;
    displayInvoices(filteredInvoices);
}

function openNewInvoiceModal() {
    showInfo('Fonctionnalit√© en d√©veloppement');
}

function viewInvoice(id) {
    showInfo(`Ouverture facture ${id}`);
}

async function downloadInvoicePDF(id) {
    try {
        const invoice = await window.InvoiceAPI.get(id);
        await window.NummaExports.generateInvoicePDF(invoice);
        showSuccess('PDF g√©n√©r√©');
    } catch (error) {
        showError('Erreur de g√©n√©ration PDF');
    }
}

async function markInvoiceAsPaid(id) {
    if (!confirm('Marquer cette facture comme pay√©e ?')) return;
    
    try {
        await window.InvoiceAPI.markAsPaid(id);
        await loadInvoices();
    } catch (error) {
        console.error('Mark paid failed:', error);
    }
}

function exportInvoices() {
    try {
        window.NummaExports.exportToCSV(
            filteredInvoices,
            `factures_${new Date().toISOString().split('T')[0]}.csv`
        );
        showSuccess('Export r√©ussi');
    } catch (error) {
        showError('Erreur d\'export');
    }
}

loadInvoices();
</script>
