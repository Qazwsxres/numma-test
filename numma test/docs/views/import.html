<!-- ========================================
     IMPORT VIEW
     Data import from various formats
     ======================================== -->

<div class="import-container">
    <div class="card">
        <div class="card-title">üìÅ Import de donn√©es</div>
        <p style="color: var(--text-gray); margin-bottom: 2rem;">
            Importez vos donn√©es comptables, factures, relev√©s bancaires et autres documents.
        </p>

        <!-- Import Types -->
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
            <!-- FEC Import -->
            <div class="card" style="cursor: pointer;" onclick="triggerFileInput('fecFileInput')">
                <h3>üìä Fichier FEC</h3>
                <p style="color: var(--text-gray); font-size: 0.875rem;">
                    Format standard pour l'administration fiscale
                </p>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); triggerFileInput('fecFileInput')">
                        S√©lectionner un fichier
                    </button>
                </div>
            </div>

            <!-- CSV Import -->
            <div class="card" style="cursor: pointer;" onclick="triggerFileInput('csvFileInput')">
                <h3>üìÑ Fichier CSV</h3>
                <p style="color: var(--text-gray); font-size: 0.875rem;">
                    Importez vos donn√©es au format CSV
                </p>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); triggerFileInput('csvFileInput')">
                        S√©lectionner un fichier
                    </button>
                </div>
            </div>

            <!-- Bank Statement -->
            <div class="card" style="cursor: pointer;" onclick="triggerFileInput('bankFileInput')">
                <h3>üè¶ Relev√© bancaire</h3>
                <p style="color: var(--text-gray); font-size: 0.875rem;">
                    PDF ou CSV de votre banque
                </p>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); triggerFileInput('bankFileInput')">
                        S√©lectionner un fichier
                    </button>
                </div>
            </div>

            <!-- Excel Import -->
            <div class="card" style="cursor: pointer;" onclick="triggerFileInput('excelFileInput')">
                <h3>üìä Fichier Excel</h3>
                <p style="color: var(--text-gray); font-size: 0.875rem;">
                    Importez vos tableaux Excel (.xlsx)
                </p>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); triggerFileInput('excelFileInput')">
                        S√©lectionner un fichier
                    </button>
                </div>
            </div>
        </div>

        <!-- Drop Zone -->
        <div id="dropZone" 
             style="border: 2px dashed var(--border); border-radius: 12px; padding: 3rem; text-align: center; margin-top: 2rem; background: var(--bg-light);"
             ondrop="handleDrop(event)" 
             ondragover="handleDragOver(event)"
             ondragleave="handleDragLeave(event)">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üì§</div>
            <div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
                Glissez-d√©posez vos fichiers ici
            </div>
            <div style="color: var(--text-gray);">
                Formats support√©s: FEC, CSV, Excel, PDF
            </div>
        </div>

        <!-- Hidden file inputs -->
        <input type="file" id="fecFileInput" accept=".txt,.fec,.csv" style="display: none;" onchange="handleFileSelect(event, 'fec')">
        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleFileSelect(event, 'csv')">
        <input type="file" id="bankFileInput" accept=".pdf,.csv" style="display: none;" onchange="handleFileSelect(event, 'bank')">
        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event, 'excel')">
    </div>

    <!-- Import History -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">Historique des imports</div>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Fichier</th>
                    <th>Type</th>
                    <th>Lignes</th>
                    <th>Statut</th>
                </tr>
            </thead>
            <tbody id="importHistoryTableBody">
                <tr>
                    <td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-gray);">
                        Aucun import r√©cent
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
console.log('üìÅ Import view loaded');

function triggerFileInput(inputId) {
    document.getElementById(inputId).click();
}

function handleFileSelect(event, type) {
    const file = event.target.files[0];
    if (!file) return;
    
    processFile(file, type);
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = 'var(--primary)';
    event.currentTarget.style.background = '#eff6ff';
}

function handleDragLeave(event) {
    event.currentTarget.style.borderColor = 'var(--border)';
    event.currentTarget.style.background = 'var(--bg-light)';
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.style.borderColor = 'var(--border)';
    event.currentTarget.style.background = 'var(--bg-light)';
    
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        processFile(files[0], 'auto');
    }
}

async function processFile(file, type) {
    console.log('Processing file:', file.name, 'type:', type);
    
    showInfo(`Import de ${file.name} en cours...`);
    
    try {
        // Detect type if auto
        if (type === 'auto') {
            if (file.name.endsWith('.fec') || file.name.endsWith('.txt')) {
                type = 'fec';
            } else if (file.name.endsWith('.csv')) {
                type = 'csv';
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                type = 'excel';
            } else if (file.name.endsWith('.pdf')) {
                type = 'bank';
            }
        }
        
        const formData = new FormData();
        formData.append('file', file);
        formData.append('type', type);
        
        const token = getSecureToken();
        const headers = await addCSRFHeader({
            'Authorization': `Bearer ${token}`
        });
        
        const response = await fetch('https://optimis-fiscale-production.up.railway.app/api/import', {
            method: 'POST',
            headers: headers,
            body: formData,
            credentials: 'include'
        });

        if (!response.ok) {
            const error = await response.json().catch(() => ({ detail: 'Import failed' }));
            throw new Error(error.detail);
        }

        const result = await response.json();
        
        showSuccess(`‚úÖ ${result.imported || 0} ligne(s) import√©e(s)`);
        
        addToImportHistory(file.name, type, result.imported || 0);
        
    } catch (error) {
        console.error('Import failed:', error);
        showError(`Erreur d'import: ${error.message}`);
    }
}

function addToImportHistory(filename, type, lines) {
    const tbody = document.getElementById('importHistoryTableBody');
    
    if (tbody.children.length === 1 && tbody.children[0].cells.length === 1) {
        tbody.innerHTML = '';
    }
    
    const row = tbody.insertRow(0);
    row.innerHTML = `
        <td>${new Date().toLocaleString('fr-FR')}</td>
        <td>${escapeHtml(filename)}</td>
        <td>${createBadge(type.toUpperCase(), 'info')}</td>
        <td>${lines}</td>
        <td>${createBadge('R√©ussi', 'success')}</td>
    `;
}

function initializeDropZones() {
    console.log('Drop zones initialized');
}

console.log('‚úÖ Import view initialized');
</script>
