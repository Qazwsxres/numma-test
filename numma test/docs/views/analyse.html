<!-- Analyse View -->
<div class="analyse-container">
    <div class="card">
        <div class="card-title">ðŸ“ˆ Analyse fiscale</div>
        <p style="color: var(--text-gray); margin-bottom: 2rem;">
            Analyses et optimisations fiscales pour votre entreprise.
        </p>

        <!-- Tax Summary -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">TVA collectÃ©e</div>
                <div class="stat-value" id="statVATCollected">â‚¬ 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">TVA dÃ©ductible</div>
                <div class="stat-value" id="statVATDeductible">â‚¬ 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">TVA Ã  payer</div>
                <div class="stat-value" id="statVATPay">â‚¬ 0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">IS estimÃ©</div>
                <div class="stat-value" id="statCorporateTax">â‚¬ 0</div>
            </div>
        </div>

        <!-- Recommendations -->
        <div class="card">
            <h3>ðŸ’¡ Recommandations fiscales</h3>
            <div id="recommendations">
                <p style="color: var(--text-gray); text-align: center; padding: 2rem;">
                    Chargement des recommandations...
                </p>
            </div>
        </div>
    </div>
</div>

<script>
console.log('ðŸ“ˆ Analyse view loaded');

async function loadTaxAnalysis() {
    try {
        const token = getSecureToken();
        const response = await fetch('https://optimis-fiscale-production.up.railway.app/api/tax/analysis', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (response.ok) {
            const data = await response.json();
            
            document.getElementById('statVATCollected').textContent = formatCurrency(data.vat_collected || 0);
            document.getElementById('statVATDeductible').textContent = formatCurrency(data.vat_deductible || 0);
            document.getElementById('statVATPay').textContent = formatCurrency(data.vat_to_pay || 0);
            document.getElementById('statCorporateTax').textContent = formatCurrency(data.corporate_tax || 0);
            
            displayRecommendations(data.recommendations || []);
        }
    } catch (error) {
        console.error('Tax analysis failed:', error);
    }
}

function displayRecommendations(recommendations) {
    const container = document.getElementById('recommendations');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <p style="color: var(--success); text-align: center; padding: 2rem;">
                âœ… Aucune recommandation pour le moment
            </p>
        `;
        return;
    }
    
    container.innerHTML = recommendations.map(rec => `
        <div style="padding: 1rem; background: var(--bg-light); border-radius: 8px; margin-bottom: 1rem;">
            <strong>${escapeHtml(rec.title)}</strong><br>
            <span style="color: var(--text-gray);">${escapeHtml(rec.description)}</span>
        </div>
    `).join('');
}

loadTaxAnalysis();
</script>
