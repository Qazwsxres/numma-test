<!-- ========================================
     RH VIEW
     Employee & payroll management
     ======================================== -->

<div class="rh-container">
    <!-- Stats -->
    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
        <div class="stat-card">
            <div class="stat-label">Employ√©s actifs</div>
            <div class="stat-value" id="statEmployees">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Masse salariale mensuelle</div>
            <div class="stat-value" id="statPayroll">‚Ç¨ 0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Fiches de paie ce mois</div>
            <div class="stat-value" id="statPayslips">0</div>
        </div>
    </div>

    <!-- Header -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">Gestion des employ√©s</div>
            <button class="btn btn-primary" onclick="openAddEmployeeModal()">
                ‚ûï Nouvel employ√©
            </button>
        </div>
        
        <input type="text" 
               id="employeeSearch" 
               class="form-input" 
               placeholder="Rechercher par nom, pr√©nom ou poste..."
               onkeyup="filterEmployees()"
               style="margin-top: 1rem;">
    </div>

    <!-- Employees Table -->
    <div class="card">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Nom complet</th>
                    <th>Poste</th>
                    <th>Type de contrat</th>
                    <th>Date d'embauche</th>
                    <th>Salaire brut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="employeesTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem;">
                        Chargement des employ√©s...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
console.log('üë• RH view loaded');

let allEmployees = [];

async function loadEmployees() {
    console.log('Loading employees...');
    
    try {
        allEmployees = await window.EmployeeAPI.list();
        displayEmployees(allEmployees);
        updateEmployeeStats();
        
        console.log('‚úÖ Employees loaded:', allEmployees.length);
        
    } catch (error) {
        console.error('‚ùå Employee loading failed:', error);
        document.getElementById('employeesTableBody').innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--danger);">
                    Erreur de chargement<br>
                    <button class="btn btn-outline" onclick="loadEmployees()" style="margin-top: 1rem;">
                        R√©essayer
                    </button>
                </td>
            </tr>
        `;
    }
}

function displayEmployees(employees) {
    const tbody = document.getElementById('employeesTableBody');
    if (!tbody) return;

    if (!employees || employees.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-gray);">
                    Aucun employ√©
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = employees.map(emp => `
        <tr>
            <td>
                <strong>${escapeHtml(emp.first_name)} ${escapeHtml(emp.last_name)}</strong>
            </td>
            <td>${escapeHtml(emp.position || '-')}</td>
            <td>${createBadge(emp.contract_type || 'CDI', 'success')}</td>
            <td>${formatDate(emp.hire_date)}</td>
            <td style="text-align: right;">${formatCurrency(emp.gross_salary || 0)}</td>
            <td>
                <div style="display: flex; gap: 0.5rem;">
                    ${createButton('üëÅÔ∏è', `viewEmployee('${emp.id}')`, 'btn btn-outline')}
                    ${createButton('üìÑ', `generatePayslip('${emp.id}')`, 'btn btn-primary')}
                    ${createButton('‚úèÔ∏è', `editEmployee('${emp.id}')`, 'btn btn-outline')}
                </div>
            </td>
        </tr>
    `).join('');
}

function filterEmployees() {
    const search = document.getElementById('employeeSearch').value.toLowerCase();
    
    if (!search) {
        displayEmployees(allEmployees);
        return;
    }
    
    const filtered = allEmployees.filter(emp => 
        (emp.first_name || '').toLowerCase().includes(search) ||
        (emp.last_name || '').toLowerCase().includes(search) ||
        (emp.position || '').toLowerCase().includes(search)
    );
    
    displayEmployees(filtered);
}

function updateEmployeeStats() {
    const activeEmployees = allEmployees.length;
    const totalPayroll = allEmployees.reduce((sum, emp) => 
        sum + parseFloat(emp.gross_salary || 0), 0
    );
    
    document.getElementById('statEmployees').textContent = activeEmployees;
    document.getElementById('statPayroll').textContent = formatCurrency(totalPayroll);
    document.getElementById('statPayslips').textContent = '0';
}

function openAddEmployeeModal() {
    showInfo('Fonctionnalit√© en d√©veloppement');
}

function viewEmployee(id) {
    showInfo(`Affichage employ√© ${id}`);
}

function editEmployee(id) {
    showInfo(`√âdition employ√© ${id}`);
}

async function generatePayslip(employeeId) {
    const now = new Date();
    const month = now.getMonth() + 1;
    const year = now.getFullYear();
    
    try {
        await window.EmployeeAPI.generatePayslip(employeeId, month, year);
    } catch (error) {
        console.error('Payslip generation failed:', error);
    }
}

loadEmployees();
</script>
