<!-- ========================================
     DASHBOARD VIEW
     Main overview with stats, charts, and quick actions
     ======================================== -->

<div class="dashboard-container">
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Chiffre d'affaires</div>
            <div class="stat-value" id="statRevenue">‚Ç¨ 0</div>
            <div class="stat-change positive" id="statRevenueChange">+0%</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Factures impay√©es</div>
            <div class="stat-value" id="statUnpaid">0</div>
            <div class="stat-change" id="statUnpaidAmount">‚Ç¨ 0</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Employ√©s</div>
            <div class="stat-value" id="statEmployees">0</div>
            <div class="stat-change" id="statEmployeesChange">Actifs</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Tr√©sorerie</div>
            <div class="stat-value" id="statCash">‚Ç¨ 0</div>
            <div class="stat-change" id="statCashChange">Solde actuel</div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Revenue Chart -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">√âvolution du chiffre d'affaires</div>
                <select id="revenueChartPeriod" class="form-select" style="width: auto;" onchange="loadDashboardChart()">
                    <option value="week">7 derniers jours</option>
                    <option value="month" selected>30 derniers jours</option>
                    <option value="year">12 derniers mois</option>
                </select>
            </div>
            <canvas id="revenueChart" style="max-height: 300px;"></canvas>
        </div>

        <!-- Recent Invoices -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">Factures r√©centes</div>
                <a href="#" onclick="switchView('factures'); return false;" class="btn btn-outline">Voir tout</a>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>N¬∞</th>
                        <th>Client</th>
                        <th>Montant</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody id="recentInvoicesTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 2rem;">
                            Chargement...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Alerts & Actions Row -->
    <div class="dashboard-grid">
        <!-- Alerts -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">üîî Alertes</div>
            </div>
            <div id="dashboardAlerts">
                <p style="color: var(--text-gray); text-align: center; padding: 2rem;">
                    Chargement des alertes...
                </p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-title" style="margin-bottom: 1rem;">Actions rapides</div>
            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <button class="btn btn-primary" onclick="openNewInvoiceModal()">
                    üìÑ Nouvelle facture
                </button>
                <button class="btn btn-outline" onclick="switchView('import')">
                    üìÅ Importer des donn√©es
                </button>
                <button class="btn btn-outline" onclick="switchView('fec')">
                    üìä Voir le FEC
                </button>
                <button class="btn btn-outline" onclick="switchView('pointage')">
                    ‚è∞ Pointage
                </button>
            </div>
        </div>
    </div>

    <!-- Upcoming Deadlines -->
    <div class="card">
        <div class="card-header">
            <div class="card-title">üìÖ √âch√©ances √† venir</div>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Date</th>
                    <th>Montant</th>
                </tr>
            </thead>
            <tbody id="deadlinesTableBody">
                <tr>
                    <td colspan="4" style="text-align: center; padding: 2rem;">
                        Chargement...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
console.log('üìä Dashboard view loaded');

let dashboardChart = null;

// =====================================================
// DATA LOADING
// =====================================================

async function loadDashboardData() {
    console.log('Loading dashboard data...');
    
    try {
        await Promise.all([
            loadDashboardStats(),
            loadDashboardChart(),
            loadRecentInvoices(),
            loadAlerts(),
            loadDeadlines()
        ]);
        
        console.log('‚úÖ Dashboard loaded');
        
    } catch (error) {
        console.error('‚ùå Dashboard loading failed:', error);
        showError('Erreur de chargement du tableau de bord');
    }
}

async function loadDashboardStats() {
    try {
        const token = getSecureToken();
        const response = await fetch('https://optimis-fiscale-production.up.railway.app/api/dashboard/stats', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Stats loading failed');

        const stats = await response.json();
        
        document.getElementById('statRevenue').textContent = formatCurrency(stats.revenue || 0);
        document.getElementById('statRevenueChange').textContent = `${stats.revenue_change >= 0 ? '+' : ''}${stats.revenue_change}%`;
        document.getElementById('statRevenueChange').className = `stat-change ${stats.revenue_change >= 0 ? 'positive' : 'negative'}`;
        
        document.getElementById('statUnpaid').textContent = stats.unpaid_count || 0;
        document.getElementById('statUnpaidAmount').textContent = formatCurrency(stats.unpaid_amount || 0);
        
        document.getElementById('statEmployees').textContent = stats.employees || 0;
        
        document.getElementById('statCash').textContent = formatCurrency(stats.cash_balance || 0);
        
    } catch (error) {
        console.error('Stats loading failed:', error);
    }
}

function initDashboardChart() {
    loadDashboardChart();
}

async function loadDashboardChart() {
    const canvas = document.getElementById('revenueChart');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const period = document.getElementById('revenueChartPeriod').value;
    
    try {
        const token = getSecureToken();
        const response = await fetch(`https://optimis-fiscale-production.up.railway.app/api/analytics/revenue?period=${period}`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Chart data loading failed');

        const data = await response.json();
        
        // Destroy existing chart
        if (dashboardChart) {
            dashboardChart.destroy();
        }
        
        dashboardChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels || [],
                datasets: [{
                    label: 'Chiffre d\'affaires',
                    data: data.values || [],
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '‚Ç¨ ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
        
    } catch (error) {
        console.error('Chart loading failed:', error);
    }
}

async function loadRecentInvoices() {
    try {
        const invoices = await window.InvoiceAPI.list({ limit: 5, sort: 'recent' });
        
        const tbody = document.getElementById('recentInvoicesTableBody');
        if (!invoices || invoices.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 1rem; color: var(--text-gray);">
                        Aucune facture r√©cente
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = invoices.slice(0, 5).map(inv => `
            <tr style="cursor: pointer;" onclick="viewInvoice('${inv.id}')">
                <td><strong>${escapeHtml(inv.number)}</strong></td>
                <td>${escapeHtml(inv.client_name)}</td>
                <td style="text-align: right;">${formatCurrency(inv.total_ttc)}</td>
                <td>${createBadge(inv.status === 'paid' ? 'Pay√©e' : inv.status === 'sent' ? 'Envoy√©e' : 'Brouillon', inv.status === 'paid' ? 'success' : 'warning')}</td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Recent invoices loading failed:', error);
    }
}

async function loadAlerts() {
    try {
        const token = getSecureToken();
        const response = await fetch('https://optimis-fiscale-production.up.railway.app/api/alerts', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Alerts loading failed');

        const alerts = await response.json();
        const container = document.getElementById('dashboardAlerts');
        
        if (!alerts || alerts.length === 0) {
            container.innerHTML = `
                <p style="color: var(--success); text-align: center; padding: 2rem;">
                    ‚úÖ Aucune alerte
                </p>
            `;
            return;
        }
        
        container.innerHTML = alerts.slice(0, 3).map(alert => `
            <div class="card" style="margin-bottom: 0.75rem; padding: 0.75rem; border-left: 3px solid ${alert.type === 'error' ? 'var(--danger)' : 'var(--warning)'};">
                <strong>${escapeHtml(alert.title)}</strong><br>
                <small style="color: var(--text-gray);">${escapeHtml(alert.message)}</small>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Alerts loading failed:', error);
    }
}

async function loadDeadlines() {
    try {
        const token = getSecureToken();
        const response = await fetch('https://optimis-fiscale-production.up.railway.app/api/deadlines', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Deadlines loading failed');

        const deadlines = await response.json();
        const tbody = document.getElementById('deadlinesTableBody');
        
        if (!deadlines || deadlines.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="4" style="text-align: center; padding: 1rem; color: var(--text-gray);">
                        Aucune √©ch√©ance
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = deadlines.slice(0, 5).map(deadline => `
            <tr>
                <td>${createBadge(deadline.type, 'info')}</td>
                <td>${escapeHtml(deadline.description)}</td>
                <td>${formatDate(deadline.date)}</td>
                <td style="text-align: right;">${formatCurrency(deadline.amount || 0)}</td>
            </tr>
        `).join('');
        
    } catch (error) {
        console.error('Deadlines loading failed:', error);
    }
}

// =====================================================
// ACTIONS
// =====================================================

function openNewInvoiceModal() {
    showInfo('Fonctionnalit√© en cours de d√©veloppement');
}

function viewInvoice(id) {
    switchView('factures');
    setTimeout(() => {
        showInfo(`Ouverture de la facture ${id}`);
    }, 500);
}

// =====================================================
// INITIALIZATION
// =====================================================

loadDashboardData();

console.log('‚úÖ Dashboard initialized');
</script>
